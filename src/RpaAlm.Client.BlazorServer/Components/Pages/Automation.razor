@page "/automation"
@rendermode InteractiveServer
@inject AutomationApiClient ApiClient
@inject SegmentApiClient SegmentApiClient
@inject RegionApiClient RegionApiClient
@inject FunctionApiClient FunctionApiClient
@inject StatusApiClient StatusApiClient
@inject JjedsHelperApiClient JjedsHelperApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Automation Management</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Automation Management</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2">
            <MudDataGrid T="AutomationDto" Items="@entities" Dense="true" Hover="true"
                         Loading="@loading" RowClick="@OnRowClick" SelectedItemChanged="@OnRowSelected">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                    <PropertyColumn Property="x => x.Name" Title="Name" />
                    <PropertyColumn Property="x => x.SegmentID" Title="Segment" />
                    <PropertyColumn Property="x => x.RegionID" Title="Region" />
                    <PropertyColumn Property="x => x.StatusID" Title="Status" />
                </Columns>
            </MudDataGrid>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-4" Style="max-height: 700px; overflow-y: auto;">
            <MudText Typo="Typo.h6" Class="mb-4">@(isEditing ? "Edit Automation" : "Add New Automation")</MudText>

            <EditForm Model="@currentEntity" OnValidSubmit="HandleSubmit">
                <MudTextField @bind-Value="currentEntity.Name"
                              Label="Name"
                              Required="true"
                              MaxLength="255"
                              Margin="Margin.Dense"
                              Class="mb-3" />

                <MudSelect @bind-Value="currentEntity.SegmentID"
                           Label="Segment"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var segment in segments)
                    {
                        <MudSelectItem Value="@((int?)segment.Id)">@segment.Code</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.RegionID"
                           Label="Region"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var region in regions)
                    {
                        <MudSelectItem Value="@((int?)region.Id)">@region.Code</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.FunctionID"
                           Label="Function"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var function in functions)
                    {
                        <MudSelectItem Value="@((int?)function.Id)">@function.Code</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.StatusID"
                           Label="Status"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var status in statuses)
                    {
                        <MudSelectItem Value="@((int?)status.Id)">@status.Code</MudSelectItem>
                    }
                </MudSelect>

                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Personnel Assignments</MudText>

                <MudSelect @bind-Value="currentEntity.BtoWWID"
                           Label="BTO (Business Technology Owner)"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var employee in employees)
                    {
                        <MudSelectItem Value="@employee.Wwid">@employee.Wwid - @employee.CommonName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.BoWWID"
                           Label="BO (Business Owner)"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var employee in employees)
                    {
                        <MudSelectItem Value="@employee.Wwid">@employee.Wwid - @employee.CommonName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.FcWWID"
                           Label="FC (Functional Consultant)"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var employee in employees)
                    {
                        <MudSelectItem Value="@employee.Wwid">@employee.Wwid - @employee.CommonName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.SseWWID"
                           Label="SSE (Senior Systems Engineer)"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var employee in employees)
                    {
                        <MudSelectItem Value="@employee.Wwid">@employee.Wwid - @employee.CommonName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.LseWWID"
                           Label="LSE (Lead Systems Engineer)"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var employee in employees)
                    {
                        <MudSelectItem Value="@employee.Wwid">@employee.Wwid - @employee.CommonName</MudSelectItem>
                    }
                </MudSelect>

                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Build Information</MudText>

                <MudTextField @bind-Value="currentEntity.BuildZcode"
                              Label="Build Z-Code"
                              MaxLength="10"
                              Margin="Margin.Dense"
                              Class="mb-3" />

                <MudTextField @bind-Value="currentEntity.BuildCostCenter"
                              Label="Build Cost Center"
                              MaxLength="10"
                              Margin="Margin.Dense"
                              Class="mb-4" />

                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@(isEditing ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
                        @(isEditing ? "Update" : "Add")
                    </MudButton>
                    <MudButton OnClick="ClearForm"
                               Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear">
                        Clear
                    </MudButton>
                    <MudButton OnClick="HandleDelete"
                               Variant="Variant.Filled"
                               Color="Color.Error"
                               Disabled="@(!isEditing)"
                               StartIcon="@Icons.Material.Filled.Delete">
                        Delete
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<AutomationDto> entities = new();
    private AutomationDto currentEntity = new();
    private int? selectedId;
    private bool isEditing => selectedId.HasValue;
    private bool loading;

    // Reference data for dropdowns
    private List<SegmentDto> segments = new();
    private List<RegionDto> regions = new();
    private List<FunctionDto> functions = new();
    private List<StatusDto> statuses = new();
    private List<JjedsHelperDto> employees = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceDataAsync();
        await LoadEntitiesAsync();
    }

    private async Task LoadReferenceDataAsync()
    {
        try
        {
            segments = await SegmentApiClient.GetAllAsync();
            regions = await RegionApiClient.GetAllAsync();
            functions = await FunctionApiClient.GetAllAsync();
            statuses = await StatusApiClient.GetAllAsync();
            employees = await JjedsHelperApiClient.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reference data: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEntitiesAsync()
    {
        loading = true;
        try
        {
            entities = await ApiClient.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void OnRowClick(DataGridRowClickEventArgs<AutomationDto> args)
    {
        // Row selection handled by SelectedItemChanged
    }

    private void OnRowSelected(AutomationDto? selected)
    {
        if (selected != null)
        {
            selectedId = selected.Id;
            currentEntity = new AutomationDto
            {
                Name = selected.Name,
                SegmentID = selected.SegmentID,
                RegionID = selected.RegionID,
                FunctionID = selected.FunctionID,
                StatusID = selected.StatusID,
                BtoWWID = selected.BtoWWID,
                BoWWID = selected.BoWWID,
                FcWWID = selected.FcWWID,
                BuildZcode = selected.BuildZcode,
                BuildCostCenter = selected.BuildCostCenter,
                SseWWID = selected.SseWWID,
                LseWWID = selected.LseWWID
            };
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (isEditing)
            {
                var request = new AutomationUpdateRequest
                {
                    Name = currentEntity.Name?.Trim() ?? string.Empty,
                    SegmentID = currentEntity.SegmentID,
                    RegionID = currentEntity.RegionID,
                    FunctionID = currentEntity.FunctionID,
                    StatusID = currentEntity.StatusID,
                    BtoWWID = currentEntity.BtoWWID?.Trim(),
                    BoWWID = currentEntity.BoWWID?.Trim(),
                    FcWWID = currentEntity.FcWWID?.Trim(),
                    BuildZcode = currentEntity.BuildZcode?.Trim(),
                    BuildCostCenter = currentEntity.BuildCostCenter?.Trim(),
                    SseWWID = currentEntity.SseWWID?.Trim(),
                    LseWWID = currentEntity.LseWWID?.Trim()
                };
                await ApiClient.UpdateAsync(selectedId!.Value, request);
                Snackbar.Add("Automation updated successfully", Severity.Success);
            }
            else
            {
                var request = new AutomationCreateRequest
                {
                    Name = currentEntity.Name?.Trim() ?? string.Empty,
                    SegmentID = currentEntity.SegmentID,
                    RegionID = currentEntity.RegionID,
                    FunctionID = currentEntity.FunctionID,
                    StatusID = currentEntity.StatusID,
                    BtoWWID = currentEntity.BtoWWID?.Trim(),
                    BoWWID = currentEntity.BoWWID?.Trim(),
                    FcWWID = currentEntity.FcWWID?.Trim(),
                    BuildZcode = currentEntity.BuildZcode?.Trim(),
                    BuildCostCenter = currentEntity.BuildCostCenter?.Trim(),
                    SseWWID = currentEntity.SseWWID?.Trim(),
                    LseWWID = currentEntity.LseWWID?.Trim()
                };
                await ApiClient.CreateAsync(request);
                Snackbar.Add("Automation created successfully", Severity.Success);
            }

            await LoadEntitiesAsync();
            ClearForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleDelete()
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this automation?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ApiClient.DeleteAsync(selectedId!.Value);
                Snackbar.Add("Automation deleted successfully", Severity.Success);
                await LoadEntitiesAsync();
                ClearForm();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ClearForm()
    {
        selectedId = null;
        currentEntity = new AutomationDto();
    }
}
