@page "/viassignments"
@rendermode InteractiveServer
@inject ViAssignmentsApiClient ApiClient
@inject VirtualIdentityApiClient VirtualIdentityApiClient
@inject AutomationEnvironmentApiClient AutomationEnvironmentApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>VI Assignments Management</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Virtual Identity Assignments Management</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2">
            <MudDataGrid T="ViAssignmentsDto" Items="@entities" Dense="true" Hover="true"
                         Loading="@loading" RowClick="@OnRowClick" SelectedItemChanged="@OnRowSelected">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                    <PropertyColumn Property="x => x.VirtualIdentityID" Title="Virtual Identity" />
                    <PropertyColumn Property="x => x.AutomationEnvironmentID" Title="Automation Env" />
                    <PropertyColumn Property="x => x.Percentage" Title="%" />
                    <PropertyColumn Property="x => x.StartDate" Title="Start" Format="yyyy-MM-dd" />
                    <PropertyColumn Property="x => x.EndDate" Title="End" Format="yyyy-MM-dd" />
                </Columns>
            </MudDataGrid>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">@(isEditing ? "Edit Assignment" : "Add New Assignment")</MudText>

            <EditForm Model="@currentEntity" OnValidSubmit="HandleSubmit">
                <MudSelect @bind-Value="currentEntity.VirtualIdentityID"
                           Label="Virtual Identity"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var vi in virtualIdentities)
                    {
                        <MudSelectItem Value="@((int?)vi.Id)">@vi.AccountName (@vi.Id)</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="currentEntity.AutomationEnvironmentID"
                           Label="Automation Environment"
                           Clearable="true"
                           Margin="Margin.Dense"
                           Class="mb-3">
                    @foreach (var env in automationEnvironments)
                    {
                        <MudSelectItem Value="@((int?)env.Id)">ID: @env.Id</MudSelectItem>
                    }
                </MudSelect>

                <MudNumericField @bind-Value="currentEntity.Percentage"
                                 Label="Percentage"
                                 Min="0"
                                 Max="100"
                                 Margin="Margin.Dense"
                                 Class="mb-3" />

                <MudDatePicker @bind-Date="startDate"
                               Label="Start Date"
                               Margin="Margin.Dense"
                               Class="mb-3" />

                <MudDatePicker @bind-Date="endDate"
                               Label="End Date"
                               Margin="Margin.Dense"
                               Class="mb-4" />

                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@(isEditing ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
                        @(isEditing ? "Update" : "Add")
                    </MudButton>
                    <MudButton OnClick="ClearForm"
                               Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear">
                        Clear
                    </MudButton>
                    <MudButton OnClick="HandleDelete"
                               Variant="Variant.Filled"
                               Color="Color.Error"
                               Disabled="@(!isEditing)"
                               StartIcon="@Icons.Material.Filled.Delete">
                        Delete
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<ViAssignmentsDto> entities = new();
    private ViAssignmentsDto currentEntity = new();
    private int? selectedId;
    private bool isEditing => selectedId.HasValue;
    private bool loading;
    private DateTime? startDate;
    private DateTime? endDate;

    private List<VirtualIdentityDto> virtualIdentities = new();
    private List<AutomationEnvironmentDto> automationEnvironments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceDataAsync();
        await LoadEntitiesAsync();
    }

    private async Task LoadReferenceDataAsync()
    {
        try
        {
            virtualIdentities = await VirtualIdentityApiClient.GetAllAsync();
            automationEnvironments = await AutomationEnvironmentApiClient.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reference data: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEntitiesAsync()
    {
        loading = true;
        try
        {
            entities = await ApiClient.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void OnRowClick(DataGridRowClickEventArgs<ViAssignmentsDto> args)
    {
        // Row selection handled by SelectedItemChanged
    }

    private void OnRowSelected(ViAssignmentsDto? selected)
    {
        if (selected != null)
        {
            selectedId = selected.Id;
            currentEntity = new ViAssignmentsDto
            {
                VirtualIdentityID = selected.VirtualIdentityID,
                AutomationEnvironmentID = selected.AutomationEnvironmentID,
                Percentage = selected.Percentage,
                StartDate = selected.StartDate,
                EndDate = selected.EndDate
            };
            startDate = selected.StartDate;
            endDate = selected.EndDate;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            currentEntity.StartDate = startDate;
            currentEntity.EndDate = endDate;

            if (isEditing)
            {
                var request = new ViAssignmentsUpdateRequest
                {
                    VirtualIdentityID = currentEntity.VirtualIdentityID,
                    AutomationEnvironmentID = currentEntity.AutomationEnvironmentID,
                    Percentage = currentEntity.Percentage,
                    StartDate = currentEntity.StartDate,
                    EndDate = currentEntity.EndDate
                };
                await ApiClient.UpdateAsync(selectedId!.Value, request);
                Snackbar.Add("VI Assignment updated successfully", Severity.Success);
            }
            else
            {
                var request = new ViAssignmentsCreateRequest
                {
                    VirtualIdentityID = currentEntity.VirtualIdentityID,
                    AutomationEnvironmentID = currentEntity.AutomationEnvironmentID,
                    Percentage = currentEntity.Percentage,
                    StartDate = currentEntity.StartDate,
                    EndDate = currentEntity.EndDate
                };
                await ApiClient.CreateAsync(request);
                Snackbar.Add("VI Assignment created successfully", Severity.Success);
            }

            await LoadEntitiesAsync();
            ClearForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleDelete()
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this VI assignment?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ApiClient.DeleteAsync(selectedId!.Value);
                Snackbar.Add("VI Assignment deleted successfully", Severity.Success);
                await LoadEntitiesAsync();
                ClearForm();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ClearForm()
    {
        selectedId = null;
        currentEntity = new ViAssignmentsDto();
        startDate = null;
        endDate = null;
    }
}
